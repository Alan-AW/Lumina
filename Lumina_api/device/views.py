import json

from rest_framework.views import APIView
from django.http import JsonResponse

from device.models import MessageQueueModel
from device.rabbit_mq.producer import start
from utils.methods import return_response


class SendMessage(APIView):
    authentication_classes = []
    permission_classes = []
    throttle_classes = []

    def get(self, request):
        msg = {
            "type": "action",
            "hardware": ["lighting", "led_pwm"],
            "instruction": "turn_on",
            "value": [100, 100, 100],
            "curve": "linear",
            "curve_duration": "00:30:00"
        }
        start(msg)
        return JsonResponse({'status': 'success'})


class GetUnitSensorView(APIView):
    authentication_classes = []
    permission_classes = []
    throttle_classes = []

    def get(self, request, device_id):
        queryset = MessageQueueModel.objects.filter(device_id=device_id).order_by('-id').first()
        content = queryset.content if queryset else {}
        response = return_response(data=content)
        return JsonResponse(response)


class TestCreateDataView(APIView):
    authentication_classes = []
    permission_classes = []
    throttle_classes = []

    def get(self, request):
        MessageQueueModel.objects.create(
            device_id='8RC4KBZ7', content=json.dumps(
                {
                    "data": {
                        "lighting": {
                            "spectra_main_led": 30,
                            "spectra_450_led": 30,
                            "spectra_660_led": 30,
                            "spectra_uva": False,
                            "spectra_uvb": False,
                            "spectra_uvc": False,
                            "spectra_450_laser": False,
                            "spectra_660_laser": False,
                            "plant_uv": False,
                            "last_updated": "2024-04-25T17:24:00.223237+0800"
                        },
                        "irthermal": {
                            "reading": [
                                [
                                    21.97,
                                    20.97,
                                    22.64,
                                    22.6,
                                    23.24,
                                    22.07,
                                    22.84,
                                    23.27,
                                    23.2,
                                    22.05,
                                    22.88,
                                    23.41,
                                    23.38,
                                    22.49,
                                    23.21,
                                    23.69,
                                    23.37,
                                    22.39,
                                    22.71,
                                    23.68,
                                    23.54,
                                    22.19,
                                    22.97,
                                    23.71,
                                    22.67,
                                    22.28,
                                    22.57,
                                    23.63,
                                    22.37,
                                    21.3,
                                    21.75,
                                    22.97
                                ],
                                [
                                    20.0,
                                    24.15,
                                    21.12,
                                    23.68,
                                    21.14,
                                    24.04,
                                    21.56,
                                    23.82,
                                    21.92,
                                    24.18,
                                    22.52,
                                    23.4,
                                    21.76,
                                    24.24,
                                    22.4,
                                    23.46,
                                    21.71,
                                    24.39,
                                    22.4,
                                    23.42,
                                    21.26,
                                    23.83,
                                    22.46,
                                    23.41,
                                    20.87,
                                    24.02,
                                    22.0,
                                    22.7,
                                    21.13,
                                    23.52,
                                    21.26,
                                    22.73
                                ],
                                [
                                    22.76,
                                    21.4,
                                    22.6,
                                    22.57,
                                    22.53,
                                    21.72,
                                    22.53,
                                    23.15,
                                    22.28,
                                    21.83,
                                    22.5,
                                    23.42,
                                    22.67,
                                    22.3,
                                    22.62,
                                    23.3,
                                    23.3,
                                    22.13,
                                    22.5,
                                    23.7,
                                    23.04,
                                    22.48,
                                    22.7,
                                    23.27,
                                    23.17,
                                    22.19,
                                    22.59,
                                    23.7,
                                    22.97,
                                    22.22,
                                    22.6,
                                    23.25
                                ],
                                [
                                    20.51,
                                    24.98,
                                    21.91,
                                    23.47,
                                    21.09,
                                    24.01,
                                    21.94,
                                    22.72,
                                    21.66,
                                    23.85,
                                    22.01,
                                    22.95,
                                    21.88,
                                    23.99,
                                    21.97,
                                    23.25,
                                    21.7,
                                    23.62,
                                    22.12,
                                    23.13,
                                    20.85,
                                    23.67,
                                    21.95,
                                    23.25,
                                    20.99,
                                    23.57,
                                    21.91,
                                    22.77,
                                    21.01,
                                    23.53,
                                    22.27,
                                    22.59
                                ],
                                [
                                    22.92,
                                    22.12,
                                    23.22,
                                    23.51,
                                    23.12,
                                    22.18,
                                    22.84,
                                    23.63,
                                    23.21,
                                    22.37,
                                    23.1,
                                    23.35,
                                    23.34,
                                    22.2,
                                    23.3,
                                    23.63,
                                    22.97,
                                    22.86,
                                    23.21,
                                    23.87,
                                    23.31,
                                    22.22,
                                    22.86,
                                    23.54,
                                    22.99,
                                    22.09,
                                    22.71,
                                    24.08,
                                    23.14,
                                    21.73,
                                    22.51,
                                    23.29
                                ],
                                [
                                    21.05,
                                    24.4,
                                    21.93,
                                    23.51,
                                    21.35,
                                    24.43,
                                    22.26,
                                    23.56,
                                    21.74,
                                    24.76,
                                    22.81,
                                    23.77,
                                    22.2,
                                    24.62,
                                    23.1,
                                    23.92,
                                    22.21,
                                    24.29,
                                    22.86,
                                    23.94,
                                    22.27,
                                    24.11,
                                    22.15,
                                    23.3,
                                    21.28,
                                    23.68,
                                    22.23,
                                    23.29,
                                    21.14,
                                    23.85,
                                    22.03,
                                    22.86
                                ],
                                [
                                    23.55,
                                    22.29,
                                    23.38,
                                    23.52,
                                    23.49,
                                    22.98,
                                    23.47,
                                    23.82,
                                    23.36,
                                    23.05,
                                    23.59,
                                    24.12,
                                    23.54,
                                    22.86,
                                    23.64,
                                    24.13,
                                    23.73,
                                    23.35,
                                    23.95,
                                    23.97,
                                    23.78,
                                    22.9,
                                    23.37,
                                    24.43,
                                    24.16,
                                    22.77,
                                    23.27,
                                    24.19,
                                    23.85,
                                    22.32,
                                    23.59,
                                    23.68
                                ],
                                [
                                    21.32,
                                    24.62,
                                    22.18,
                                    23.78,
                                    21.48,
                                    24.48,
                                    22.7,
                                    23.99,
                                    22.12,
                                    24.32,
                                    22.92,
                                    23.45,
                                    22.48,
                                    24.48,
                                    23.19,
                                    23.55,
                                    22.14,
                                    24.59,
                                    22.92,
                                    24.03,
                                    22.12,
                                    23.99,
                                    22.7,
                                    23.75,
                                    22.3,
                                    24.1,
                                    22.29,
                                    23.67,
                                    21.84,
                                    23.78,
                                    22.45,
                                    23.15
                                ],
                                [
                                    22.9,
                                    21.74,
                                    22.72,
                                    22.7,
                                    23.33,
                                    22.73,
                                    23.21,
                                    23.47,
                                    23.59,
                                    22.75,
                                    23.46,
                                    23.76,
                                    23.28,
                                    22.52,
                                    23.24,
                                    23.81,
                                    23.45,
                                    23.17,
                                    23.37,
                                    23.6,
                                    23.53,
                                    22.84,
                                    23.68,
                                    24.24,
                                    23.68,
                                    23.23,
                                    23.46,
                                    24.26,
                                    23.58,
                                    22.45,
                                    23.16,
                                    24.49
                                ],
                                [
                                    21.69,
                                    24.68,
                                    22.46,
                                    23.05,
                                    21.67,
                                    23.88,
                                    22.54,
                                    23.48,
                                    21.87,
                                    24.19,
                                    22.39,
                                    23.53,
                                    21.69,
                                    24.27,
                                    22.49,
                                    23.46,
                                    21.93,
                                    24.16,
                                    22.59,
                                    23.29,
                                    21.76,
                                    23.95,
                                    22.33,
                                    23.41,
                                    21.91,
                                    24.24,
                                    22.45,
                                    23.23,
                                    21.86,
                                    24.09,
                                    22.57,
                                    23.37
                                ],
                                [
                                    23.05,
                                    22.71,
                                    23.83,
                                    24.04,
                                    24.17,
                                    22.86,
                                    23.57,
                                    24.01,
                                    24.16,
                                    23.1,
                                    23.92,
                                    24.17,
                                    24.24,
                                    23.21,
                                    23.72,
                                    24.26,
                                    23.57,
                                    23.0,
                                    23.38,
                                    24.42,
                                    23.57,
                                    22.93,
                                    23.46,
                                    23.72,
                                    23.31,
                                    22.48,
                                    22.63,
                                    23.77,
                                    23.04,
                                    22.62,
                                    23.35,
                                    23.81
                                ],
                                [
                                    21.21,
                                    24.56,
                                    23.1,
                                    23.41,
                                    22.54,
                                    24.82,
                                    22.56,
                                    23.47,
                                    22.57,
                                    24.84,
                                    23.05,
                                    24.01,
                                    22.75,
                                    24.75,
                                    23.55,
                                    24.02,
                                    22.69,
                                    24.87,
                                    23.24,
                                    23.72,
                                    22.52,
                                    24.7,
                                    23.05,
                                    23.86,
                                    22.36,
                                    24.27,
                                    22.37,
                                    23.35,
                                    21.78,
                                    24.27,
                                    22.83,
                                    23.74
                                ],
                                [
                                    23.61,
                                    22.42,
                                    23.68,
                                    24.43,
                                    23.68,
                                    22.95,
                                    23.73,
                                    24.49,
                                    23.72,
                                    23.1,
                                    23.62,
                                    24.7,
                                    23.82,
                                    23.15,
                                    24.17,
                                    24.38,
                                    23.73,
                                    23.07,
                                    23.64,
                                    23.91,
                                    23.97,
                                    22.88,
                                    23.83,
                                    24.37,
                                    24.68,
                                    23.99,
                                    24.27,
                                    24.74,
                                    24.08,
                                    23.21,
                                    23.95,
                                    25.05
                                ],
                                [
                                    22.13,
                                    24.32,
                                    23.09,
                                    24.67,
                                    22.61,
                                    24.7,
                                    23.16,
                                    23.87,
                                    22.88,
                                    24.9,
                                    23.46,
                                    24.44,
                                    22.85,
                                    25.04,
                                    23.29,
                                    24.29,
                                    22.64,
                                    24.96,
                                    23.68,
                                    24.17,
                                    22.48,
                                    24.94,
                                    23.35,
                                    24.45,
                                    22.96,
                                    25.35,
                                    23.44,
                                    24.42,
                                    22.26,
                                    25.01,
                                    23.68,
                                    24.4
                                ],
                                [
                                    23.06,
                                    22.11,
                                    23.62,
                                    24.78,
                                    24.12,
                                    23.14,
                                    23.39,
                                    24.29,
                                    24.23,
                                    23.78,
                                    24.48,
                                    24.92,
                                    24.68,
                                    24.11,
                                    24.92,
                                    25.02,
                                    24.52,
                                    23.96,
                                    24.59,
                                    24.91,
                                    24.38,
                                    23.58,
                                    24.04,
                                    24.58,
                                    23.83,
                                    23.55,
                                    24.6,
                                    24.84,
                                    24.21,
                                    23.69,
                                    25.13,
                                    25.5
                                ],
                                [
                                    21.94,
                                    23.98,
                                    22.96,
                                    23.61,
                                    22.24,
                                    23.97,
                                    22.67,
                                    23.37,
                                    22.07,
                                    24.26,
                                    23.13,
                                    24.16,
                                    22.68,
                                    24.77,
                                    23.54,
                                    24.43,
                                    23.11,
                                    25.84,
                                    23.97,
                                    24.58,
                                    23.28,
                                    24.53,
                                    23.1,
                                    24.11,
                                    22.51,
                                    25.59,
                                    23.9,
                                    24.67,
                                    22.39,
                                    24.96,
                                    23.28,
                                    24.52
                                ],
                                [
                                    24.04,
                                    22.86,
                                    23.97,
                                    24.53,
                                    24.12,
                                    23.42,
                                    23.78,
                                    24.58,
                                    24.16,
                                    23.31,
                                    24.06,
                                    24.28,
                                    23.34,
                                    22.67,
                                    23.17,
                                    24.04,
                                    23.5,
                                    22.96,
                                    23.43,
                                    23.74,
                                    23.51,
                                    22.92,
                                    23.49,
                                    23.87,
                                    23.71,
                                    22.98,
                                    24.27,
                                    24.31,
                                    23.56,
                                    23.44,
                                    23.6,
                                    24.81
                                ],
                                [
                                    22.13,
                                    25.05,
                                    23.32,
                                    24.03,
                                    22.57,
                                    24.71,
                                    23.42,
                                    24.04,
                                    23.02,
                                    24.96,
                                    23.32,
                                    24.35,
                                    22.9,
                                    25.07,
                                    23.38,
                                    24.27,
                                    22.9,
                                    24.7,
                                    23.47,
                                    24.34,
                                    22.19,
                                    24.39,
                                    22.99,
                                    23.85,
                                    22.37,
                                    24.93,
                                    23.27,
                                    23.81,
                                    21.86,
                                    24.8,
                                    23.21,
                                    23.4
                                ],
                                [
                                    23.84,
                                    22.85,
                                    24.12,
                                    24.78,
                                    24.23,
                                    23.2,
                                    23.83,
                                    24.8,
                                    24.43,
                                    23.46,
                                    24.68,
                                    25.08,
                                    24.16,
                                    24.01,
                                    24.53,
                                    24.94,
                                    23.9,
                                    23.83,
                                    24.18,
                                    24.73,
                                    24.64,
                                    23.56,
                                    23.47,
                                    25.09,
                                    24.02,
                                    23.52,
                                    24.54,
                                    24.63,
                                    24.24,
                                    23.24,
                                    23.69,
                                    25.04
                                ],
                                [
                                    21.88,
                                    24.36,
                                    22.93,
                                    23.81,
                                    22.51,
                                    24.77,
                                    23.2,
                                    24.46,
                                    22.95,
                                    25.05,
                                    23.43,
                                    24.62,
                                    23.1,
                                    25.16,
                                    23.67,
                                    24.66,
                                    22.76,
                                    25.05,
                                    23.15,
                                    24.64,
                                    22.43,
                                    25.13,
                                    23.37,
                                    24.01,
                                    22.73,
                                    24.79,
                                    23.3,
                                    24.53,
                                    21.96,
                                    25.55,
                                    23.24,
                                    23.74
                                ],
                                [
                                    24.3,
                                    22.48,
                                    23.99,
                                    24.04,
                                    24.03,
                                    23.13,
                                    24.03,
                                    24.31,
                                    23.92,
                                    23.07,
                                    24.14,
                                    24.65,
                                    24.25,
                                    23.23,
                                    23.99,
                                    24.84,
                                    24.43,
                                    23.72,
                                    24.82,
                                    25.13,
                                    24.4,
                                    23.58,
                                    24.37,
                                    24.89,
                                    24.8,
                                    23.67,
                                    24.02,
                                    24.78,
                                    24.11,
                                    23.01,
                                    24.26,
                                    23.99
                                ],
                                [
                                    21.85,
                                    24.84,
                                    23.13,
                                    23.97,
                                    22.41,
                                    25.08,
                                    23.73,
                                    24.22,
                                    22.7,
                                    25.0,
                                    23.35,
                                    24.09,
                                    22.47,
                                    24.95,
                                    23.06,
                                    24.39,
                                    22.82,
                                    24.89,
                                    23.28,
                                    24.39,
                                    22.55,
                                    24.95,
                                    23.57,
                                    24.12,
                                    22.08,
                                    24.72,
                                    23.33,
                                    23.88,
                                    22.0,
                                    25.32,
                                    23.34,
                                    23.44
                                ],
                                [
                                    24.26,
                                    22.83,
                                    24.43,
                                    24.27,
                                    23.84,
                                    22.85,
                                    24.22,
                                    24.67,
                                    24.23,
                                    23.27,
                                    24.12,
                                    24.34,
                                    24.38,
                                    23.47,
                                    23.94,
                                    24.6,
                                    24.43,
                                    23.26,
                                    24.28,
                                    24.76,
                                    23.73,
                                    23.62,
                                    24.12,
                                    24.55,
                                    23.86,
                                    23.4,
                                    23.77,
                                    24.61,
                                    23.58,
                                    22.73,
                                    23.73,
                                    24.79
                                ],
                                [
                                    21.95,
                                    25.23,
                                    23.29,
                                    24.48,
                                    21.79,
                                    24.9,
                                    23.3,
                                    24.16,
                                    22.8,
                                    25.64,
                                    23.97,
                                    24.48,
                                    23.0,
                                    24.87,
                                    23.12,
                                    24.48,
                                    22.63,
                                    25.0,
                                    23.62,
                                    24.22,
                                    22.33,
                                    24.84,
                                    23.39,
                                    23.82,
                                    21.92,
                                    25.09,
                                    23.07,
                                    23.83,
                                    21.84,
                                    25.1,
                                    23.08,
                                    23.7
                                ]
                            ],
                            "probe_temp": 40.87,
                            "last_updated": "2024-04-25T17:24:10.702082+0800"
                        },
                        "solar_irradiance": {
                            "solar_irradiance": 13,
                            "last_updated": "2024-04-25T17:24:10.958713+0800"
                        },
                        "fertigation": {
                            "current_ec": 0.05,
                            "current_ph": 13.87,
                            "ec_alert_min": 0.5,
                            "ec_alert_max": 4.0,
                            "ph_alert_min": 4.0,
                            "ph_alert_max": 8.0,
                            "current_water_temp": 25.0,
                            "current_water_level": 0,
                            "current_last_updated": "2024-04-25T17:23:58.705916+0800"
                        },
                        "thc": {
                            "main_upper": {
                                "position": "main_upper",
                                "temperature": 24.7,
                                "humidity": 47.5,
                                "co2": 409,
                                "vpd": 1.634,
                                "last_updated": "2024-04-25T17:23:58.961597+0800"
                            },
                            "main_lower": {
                                "position": "main_lower",
                                "temperature": 24.0,
                                "humidity": 49.5,
                                "co2": 399,
                                "vpd": 1.507,
                                "last_updated": "2024-04-25T17:23:59.507639+0800"
                            }
                        }
                    },
                    "instruction_set": {
                        "device_id": "8RC4KBZ7",
                        "data": {
                            "tod": "12:55:40",
                            "time": "2024-03-30T16:32:40+08:00",
                            "type": "instruction_set",
                            "version": "0.5A.0",
                            "device_id": "8RC4KBZ7",
                            "instructions": [
                                {
                                    "phase": "transplant_recovery",
                                    "actions": [
                                        {
                                            "type": "action",
                                            "hardware": "climate",
                                            "vpd_priority_day": "temp",
                                            "target_rh_max_day": 0.6,
                                            "target_rh_min_day": 0.43,
                                            "target_vpd_max_day": 0.7,
                                            "target_vpd_min_day": 0.42,
                                            "vpd_priority_night": "rh",
                                            "target_rh_max_night": 0.57,
                                            "target_rh_min_night": 0.46,
                                            "target_vpd_max_night": 0.7,
                                            "target_vpd_min_night": 0.42,
                                            "target_amb_temp_max_day": 28,
                                            "target_amb_temp_min_day": 16,
                                            "target_amb_temp_max_night": 28,
                                            "target_amb_temp_min_night": 16,
                                            "target_rh_deadband_max_day": 0.6,
                                            "target_rh_deadband_min_day": 0.43,
                                            "target_vpd_deadband_max_day": 0.6,
                                            "target_vpd_deadband_min_day": 0.5,
                                            "target_rh_deadband_max_night": 0.57,
                                            "target_rh_deadband_min_night": 0.46,
                                            "target_vpd_deadband_max_night": 0.66,
                                            "target_vpd_deadband_min_night": 0.5,
                                            "target_amb_temp_deadband_max_day": 24,
                                            "target_amb_temp_deadband_min_day": 18,
                                            "target_amb_temp_deadband_max_night": 24,
                                            "target_amb_temp_deadband_min_night": 18
                                        },
                                        {
                                            "type": "action",
                                            "hardware": "fertigation",
                                            "target_ec_max": 31,
                                            "target_ec_min": 1,
                                            "target_ph_max": 7,
                                            "target_ph_min": 5,
                                            "target_ec_deadband_max": 24,
                                            "target_ec_deadband_min": 1,
                                            "target_ph_deadband_max": 6.5,
                                            "target_ph_deadband_min": 5.5,
                                            "target_water_temperature_max": 24,
                                            "target_water_temperature_min": 15,
                                            "target_water_temperature_deadband_max": 22,
                                            "target_water_temperature_deadband_min": 18
                                        },
                                        {
                                            "type": "action",
                                            "hardware": "lighting",
                                            "fade_curve_type": "linear",
                                            "spectra_450_led": 50,
                                            "spectra_660_led": 50,
                                            "spectra_main_led": 100,
                                            "fade_curve_duration": "00:30:00"
                                        }
                                    ],
                                    "days_max": 14,
                                    "days_min": 7,
                                    "duration": "12:00:00"
                                }
                            ],
                            "grow_cycle_id": "18",
                            "current_cycle_start": "2024-03-30T16:32:40+08:00",
                            "current_phase": "transplant_recovery",
                            "current_phase_start": "2024-04-15T01:03:54.206626+0800"
                        },
                        "time": "2024-04-15T01:03:54.206787+0800",
                        "type": "instruction_set"
                    },
                    "deviceId": "8RC4KBZ7",
                    "version": "0.5A.0",
                    "last_updated": "++++++"
                }
            )
            )
        return JsonResponse({'status': 'ok'})
